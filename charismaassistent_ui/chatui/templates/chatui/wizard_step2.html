{% extends "chatui/base.html" %}
{% load static %}

{% block title %}Wizard · Step 2 · CharismaAssistant{% endblock %}

{% block content %}
<section class="card">
  <header class="card__header">
    <h2>Analysis Wizard</h2>
    <small class="muted">Step 2/2 · Results & Explainability</small>
  </header>

  <div class="steps">
    <div class="step muted" style="opacity:.7">
      <span style="background:rgba(255,255,255,.15);color:var(--text)">1</span> Text
    </div>
    <div class="step"><span>2</span> Analysis</div>
  </div>

  <!-- TOP SUMMARY BAR -->
  <div class="summary-bar" id="summaryBar">
    <div class="summary-line">
      <span class="summary-label">Overall charisma score:</span>
      <span class="summary-value" id="summaryScore">—</span>
    </div>

    <div class="summary-line">
      <span class="summary-label">Detected CLTs:</span>
      <span class="summary-value" id="summaryFound">—</span>
      <span class="summary-sep">|</span>
      <span class="summary-label">Consistency (ensemble):</span>
      <span class="summary-value" id="summaryConsistency">—</span>
    </div>

    <div class="summary-line" style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
      <div style="min-width: 50%;">
        <div>
          <span class="summary-label">Setup:</span>
          <span class="summary-value" id="summarySetup">—</span>
        </div>

        <!-- NEW: Run distribution / live progress -->
        <div style="margin-top:10px;">
          <div class="muted" style="margin-bottom:6px;">Run distribution (live):</div>
          <div id="runDistribution" class="result__text" style="min-height:64px; max-height:120px; overflow:auto;"></div>
        </div>
      </div>

      <!-- MODEL TOGGLE -->
      <div class="row" style="gap:10px; align-items:center;">
        <span class="muted">LLM:</span>

        <button class="btn btn-ghost btn-sm"
                type="button"
                id="btnToggleLLM"
                data-active="gpt"
                style="white-space:nowrap;">
          Select LLM: Gemini
        </button>

        <span class="badge" id="modelBadge">GPT</span>
        <span class="muted" id="runInfo">—</span>
      </div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="analysis-grid">
    <!-- LEFT: TEXT PANEL -->
    <aside class="panel panel-left">
      <div class="panel__header">
        <h3>Text (sentence-based)</h3>
        <small class="muted">Evidence is highlighted per sentence.</small>
      </div>

      <div class="panel__body" id="speechPanel"></div>

      <div class="panel__footer row" style="justify-content:space-between;">
        <a class="btn btn-ghost" href="{% url 'wizard_step1' %}">← Back</a>
        <button class="btn btn-dark" type="button" id="btnReanalyze" disabled>Re-run analysis</button>
      </div>
    </aside>

    <!-- CENTER: SCORECARD TABLE -->
    <main class="panel panel-center">
      <div class="panel__header">
        <h3>CLT scorecard</h3>
        <small class="muted">Click a CLT to open details on the right.</small>
      </div>

      <div class="panel__body" style="padding-top:6px;">
        <div class="table-wrap">
          <table class="score-table" id="scoreTable">
            <thead>
              <tr>
                <th style="width:44%;">CLT</th>
                <th style="width:8%;">✓</th>
                <th style="width:18%;">Strength</th>
                <th style="width:18%;">Confidence</th>
                <th style="width:12%;">Details</th>
              </tr>
            </thead>
            <tbody id="scoreTbody">
              <!-- JS inject -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- RIGHT: DETAIL DRAWER -->
    <aside class="panel panel-right" id="detailPanel" data-open="false">
      <div class="panel__header row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h3 id="detailTitle">Details</h3>
          <small class="muted" id="detailMeta">Select a CLT.</small>
        </div>
        <button class="btn btn-ghost" type="button" id="btnCloseDetails">✕</button>
      </div>

      <div class="panel__body" id="detailBody">
        <div class="muted">No selection yet.</div>
      </div>
    </aside>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script defer src="{% static 'chatui/wizard_step2.js' %}?v=20260222-EN-STREAM-1"></script>
{% endblock %}